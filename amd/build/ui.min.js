define("tiny_filtercodes/ui",["exports","./common","./options","./arguments"],(function(_exports,_common,_options,_arguments){Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.updateVisualLevelIndicators=_exports.removeVisualStyling=_exports.onSubmit=_exports.onInit=_exports.onFocus=_exports.onEdit=_exports.onDelete=_exports.onBeforeGetContent=_exports.applyFiltercode=_exports.addVisualStyling=_exports.addVisualLevelIndicators=void 0;
/**
   * Commands for the plugin logic of the Moodle tiny_filtercodes plugin.
   *
   * @module     tiny_filtercodes
   * @author     Leon Camus
   * @copyright  2025 onwards Leon Camus
   * @license    https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */
let _isSubmit=!1;const transformDomToSpan=function(node){let newchildren=[];node.childNodes.forEach((child=>{child.nodeType===Node.TEXT_NODE?newchildren.push(...function(node){let input=node.textContent;const output=[],echo=function(text){output.length>0&&output[output.length-1].nodeType===Node.TEXT_NODE?output[output.length-1].textContent+=text:output.push(document.createTextNode(text))};for(;input.length>0;){const start=input.search(_common.regexTagStartEnd);if(start>=0){echo(input.substring(0,start)),input=input.substring(start);const match=input.matchAll(_common.regexTagStartEnd).next().value,isClosing=!(0,_common.isNull)(match[1]),key=match[2],args=match[3],filtercode=_common.filtercodeMap[key];(0,_common.isNull)(filtercode)||isClosing&&!filtercode.around||isClosing&&!(0,_common.isNull)(args)?echo(input.substring(0,match[0].length)):isClosing?output.push(filtercode.endSpan()):output.push(filtercode.beginSpan(args?match[3].replace(/^\s+/,"").split(" "):[])),input=input.substring(match[0].length)}else{if(0===output.length)return[node];echo(input),input=""}}return output}(child)):(child.nodeType===Node.ELEMENT_NODE&&child.classList.contains(_common.classFiltercode)||transformDomToSpan(child),newchildren.push(child))})),node.innerHTML="",newchildren.forEach((child=>{node.appendChild(child)}))},addVisualStyling=function(ed){let input=ed.getContent();const element=(new DOMParser).parseFromString(input,"text/html").body;return transformDomToSpan(element),addVisualLevelIndicators(ed,element),element.innerHTML};_exports.addVisualStyling=addVisualStyling;const addVisualLevelIndicators=function(ed,el){const keyStack=[],spans=el.querySelectorAll(".".concat(_common.classFiltercode));for(const span of spans){if(_common.classFiltercodeLevels.filter((className=>span.classList.contains(className))).forEach((className=>span.classList.remove(className))),span.classList.contains(_common.classFiltercodeError)&&span.classList.remove(_common.classFiltercodeError),span.classList.contains(_common.classFiltercodeBegin)){keyStack.push(span);continue}if(!span.classList.contains(_common.classFiltercodeEnd))continue;const top=keyStack[keyStack.length-1];if((0,_common.isNull)(top)||top.dataset.filtercodekey!==span.dataset.filtercodekey){if(!keyStack.find((begin=>begin.dataset.filtercodekey===span.dataset.filtercodekey))){span.classList.add(_common.classFiltercodeError);continue}for(;keyStack.length>0&&keyStack[keyStack.length-1].dataset.filtercodekey!==span.dataset.filtercodekey;)keyStack.pop().classList.add(_common.classFiltercodeError)}keyStack.length>0?(keyStack.pop().classList.add((0,_common.classFiltercodeLevel)(keyStack.length)),span.classList.add((0,_common.classFiltercodeLevel)(keyStack.length))):span.classList.add(_common.classFiltercodeError)}for(const span of keyStack)span.classList.add(_common.classFiltercodeError)};_exports.addVisualLevelIndicators=addVisualLevelIndicators;const updateVisualLevelIndicators=function(ed){let keyStack=[];for(const span of ed.dom.select(".".concat(_common.classFiltercode)))if(_common.classFiltercodeLevels.filter((className=>span.classList.contains(className))).forEach((className=>ed.dom.removeClass(span,className))),span.classList.contains(_common.classFiltercodeError)&&ed.dom.removeClass(span,_common.classFiltercodeError),span.classList.contains(_common.classFiltercodeBegin))keyStack.push(span);else if(span.classList.contains(_common.classFiltercodeEnd)){const top=keyStack[keyStack.length-1];if((0,_common.isNull)(top)||top.dataset.filtercodekey!==span.dataset.filtercodekey){if(!keyStack.find((begin=>begin.dataset.filtercodekey===span.dataset.filtercodekey))){ed.dom.addClass(span,_common.classFiltercodeError);continue}for(;keyStack.length>0&&keyStack[keyStack.length-1].dataset.filtercodekey!==span.dataset.filtercodekey;)ed.dom.addClass(keyStack.pop(),_common.classFiltercodeError)}keyStack.length>0?(ed.dom.addClass(keyStack.pop(),(0,_common.classFiltercodeLevel)(keyStack.length)),ed.dom.addClass(span,(0,_common.classFiltercodeLevel)(keyStack.length))):ed.dom.addClass(span,_common.classFiltercodeError)}for(const span of keyStack)ed.dom.addClass(span,_common.classFiltercodeError)};_exports.updateVisualLevelIndicators=updateVisualLevelIndicators;_exports.onInit=function(ed){ed.setContent(addVisualStyling(ed)),ed.dom.addStyle((0,_options.getHighlightCss)(ed))};const removeVisualStyling=function(ed){for(const span of ed.dom.select(".".concat(_common.classFiltercode)))ed.dom.setOuterHTML(span,span.innerHTML);ed.save()};_exports.removeVisualStyling=removeVisualStyling;_exports.onFocus=function(ed){_isSubmit&&(ed.setContent(addVisualStyling(ed),{no_events:!0}),_isSubmit=!1)};_exports.onSubmit=function(ed){removeVisualStyling(ed),_isSubmit=!0};_exports.onBeforeGetContent=function(ed,content){if(!(0,_common.isNull)(content.source_view)&&!0===content.source_view){const onClose=function(ed){ed.off("close",onClose),ed.setContent(addVisualStyling(ed))};new MutationObserver(((mutations,obs)=>{const viewSrcModal=document.querySelector('[data-region="modal"]');if(viewSrcModal)return viewSrcModal.addEventListener("click",(event=>{const{action:action}=event.target.dataset;["cancel","save","hide"].includes(action)&&onClose(ed)})),void obs.disconnect();document.querySelector(".tox-dialog-wrap")&&(ed.on("CloseWindow",(()=>{onClose(ed)})),obs.disconnect())})).observe(document.body,{childList:!0,subtree:!0}),removeVisualStyling(ed)}};const getHighlightNodesFromSelect=function(ed){let nodes=null;return ed.dom.getParents(ed.selection.getStart(),(elm=>{!(0,_common.isNull)(elm.classList)&&elm.classList.contains(_common.classFiltercode)&&(nodes=function(ed,node){if(!node.classList.contains(_common.classFiltercode)||node.classList.contains(_common.classFiltercodeError))return null;const key=node.dataset.filtercodekey;if(node.classList.contains(_common.classFiltercodeError)||!node.classList.contains(_common.classFiltercodeBegin)&&!node.classList.contains(_common.classFiltercodeEnd))return{start:node,end:null};const isBegin=node.classList.contains(_common.classFiltercodeBegin),partners=ed.dom.select(".".concat(_common.classFiltercode,'[data-filtercodekey="').concat(key,'"]'));let currentlevel=0,expectedlevel=null;for(const partner of isBegin?partners:[...partners].reverse())if(partner!==node){if(partner.classList.contains(_common.classFiltercodeBegin)&&!partner.classList.contains(_common.classFiltercodeError)?currentlevel++:partner.classList.contains(_common.classFiltercodeEnd)&&!partner.classList.contains(_common.classFiltercodeError)&&currentlevel--,currentlevel===expectedlevel)return{start:isBegin?node:partner,end:isBegin?partner:node}}else expectedlevel=currentlevel,partner.classList.contains(_common.classFiltercodeBegin)&&!partner.classList.contains(_common.classFiltercodeError)?currentlevel++:partner.classList.contains(_common.classFiltercodeEnd)&&!partner.classList.contains(_common.classFiltercodeError)&&currentlevel--;return null}(ed,elm))})),nodes},hideContentToolbar=function(el){for(;!(0,_common.isNull)(el);){if(el.nodeType===Node.ELEMENT_NODE&&!(0,_common.isNull)(el.getAttribute("class"))&&-1!=el.getAttribute("class").indexOf("tox-pop-"))return void(el.style.display="none");el=el.parentNode}};_exports.onDelete=function(ed,event){if(event.isComposing||(0,_common.isNull)(event.clientX)&&46!==event.keyCode&&8!==event.keyCode)return;if(!(0,_common.isNull)(event.clientX)&&(event.target.nodeType!==Node.ELEMENT_NODE||"path"!==event.target.nodeName&&"svg"!==event.target.nodeName))return;const nodes=getHighlightNodesFromSelect(ed);if(!(0,_common.isNull)(nodes)){const{start:start,end:end}=nodes;event.preventDefault(),ed.dom.remove(start),(0,_common.isNull)(end)||ed.dom.remove(end),(0,_common.isNull)(event.clientX)||hideContentToolbar(event.target),updateVisualLevelIndicators(ed)}};_exports.applyFiltercode=async function(ed,filtercodekey,event){if((0,_common.isNull)(filtercodekey))return;const filtercode=_common.filtercodeMap[filtercodekey];if((0,_common.isNull)(filtercode))return;let args=[];if(filtercode.args.length>0&&(args=await(0,_arguments.openArgumentModal)(filtercodekey,filtercode.args.map((()=>null))),(0,_common.isNull)(args)))return;let text=ed.selection.getContent();if(""===text.trim())return(0,_common.isNull)(event)?(filtercode.around?ed.insertContent(filtercode.beginSpan(args).outerHTML+text+filtercode.endSpan().outerHTML):ed.insertContent(filtercode.beginSpan(args).outerHTML),void updateVisualLevelIndicators(ed)):void hideContentToolbar(event.target);(0,_common.isNull)(event)||hideContentToolbar(event.target);const nodes=getHighlightNodesFromSelect(ed);if((0,_common.isNull)(nodes))filtercode.around?ed.insertContent(filtercode.beginSpan(args).outerHTML+text+filtercode.endSpan().outerHTML):ed.insertContent(filtercode.beginSpan(args).outerHTML),updateVisualLevelIndicators(ed);else{const{start:start,end:end}=nodes;if(filtercode.around&&!(0,_common.isNull)(end)){const color=start.style.backgroundColor;return ed.dom.setOuterHTML(start,filtercode.beginSpan(args,color).outerHTML),void ed.dom.setOuterHTML(end,filtercode.endSpan(color).outerHTML)}if(!filtercode.around&&(0,_common.isNull)(end)){const color=start.style.backgroundColor;return void ed.dom.setOuterHTML(start,filtercode.beginSpan(args,color).outerHTML)}if(filtercode.around&&(0,_common.isNull)(end)){const color=start.style.backgroundColor;return void ed.dom.setOuterHTML(start,filtercode.beginSpan(args,color).outerHTML+filtercode.endSpan(color).outerHTML)}if(!filtercode.around&&!(0,_common.isNull)(end)){const color=start.style.backgroundColor;return ed.dom.setOuterHTML(start,filtercode.beginSpan(args,color).outerHTML),void ed.dom.remove(end)}}};_exports.onEdit=async function(ed,event){const nodes=getHighlightNodesFromSelect(ed);if(!(0,_common.isNull)(nodes)){const{start:start}=nodes;event.preventDefault();const filtercodekey=start.dataset.filtercodekey;if((0,_common.isNull)(filtercodekey))return;const filtercode=_common.filtercodeMap[filtercodekey];if((0,_common.isNull)(filtercode)||0===filtercode.args.length)return;let args=start.dataset.filtercodeargs.split(" ");if(args=await(0,_arguments.openArgumentModal)(filtercodekey,args),(0,_common.isNull)(args))return;ed.dom.setOuterHTML(start,filtercode.beginSpan(args).outerHTML),updateVisualLevelIndicators(ed)}}}));

//# sourceMappingURL=ui.min.js.map