{"version":3,"file":"commands.min.js","sources":["../src/commands.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * Commands helper for the Moodle tiny_filtercodes plugin.\n *\n * @module     tiny_filtercodes\n * @author      Leon Camus\n * @copyright   2025 onwards Leon Camus\n * @license     https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport {classFiltercode, classFiltercodeError, component, filtercodeNameMap, filtercodes} from './common';\nimport {getStrings} from 'core/str';\nimport {applyFiltercode, onBeforeGetContent, onDelete, onEdit, onFocus, onInit, onSubmit} from './ui';\nimport {filterCodesFilterExists} from \"./options\";\n\n/**\n * @typedef {Editor} Editor\n */\n\n/**\n * Get the setup function for the button and the menu entry.\n *\n * This is performed in an async function which ultimately returns the registration function as the\n * Tiny.AddOnManager.Add() function does not support async functions.\n *\n * @returns {(Editor) => void} The registration function to call within the Plugin.add function.\n */\nexport const getSetup = async() => {\n    const filtercodeNameMapKeys = Object.keys(filtercodeNameMap);\n    const filtercodeNameMapValues = Object.values(filtercodeNameMap);\n    const [\n        buttonText,\n        removeTag,\n        editTag,\n        ...filtercodeStrings\n    ] = await getStrings([\n            {key: 'filtercodes:filtercodes', component},\n            {key: 'filtercodes:removetag', component},\n            {key: 'filtercodes:edittag', component},\n            ...filtercodeNameMapValues\n        ]\n    );\n    const langKeys = Object.fromEntries(Array(filtercodeNameMapKeys.length).fill(0)\n        .map((_, i) => [filtercodeNameMapKeys[i], filtercodeStrings[i]]));\n\n    return (editor) => {\n        if (filterCodesFilterExists(editor)) {\n            editor.ui.registry.addNestedMenuItem(component, {\n                text: buttonText,\n                getSubmenuItems: () => filtercodes.map((codeorgroup) => {\n                    if (codeorgroup.codes) {\n                        return {\n                            type: 'nestedmenuitem',\n                            text: langKeys[codeorgroup.getKey()],\n                            getSubmenuItems: () => codeorgroup.codes.map((code) => ({\n                                type: 'menuitem',\n                                text: langKeys[code.getKey()],\n                                onAction: () => applyFiltercode(editor, code.id),\n                            })),\n                        };\n                    } else {\n                        return {\n                            type: 'menuitem',\n                            text: langKeys[codeorgroup.getKey()],\n                            onAction: () => applyFiltercode(editor, codeorgroup.id),\n                        };\n                    }\n                }),\n            });\n            editor.ui.registry.addButton(component + '_remove', {\n                icon: 'remove',\n                tooltip: removeTag,\n                onAction: () => onDelete(editor, event),\n            });\n            editor.ui.registry.addButton(component + '_edit', {\n                icon: 'edit-block',\n                tooltip: editTag,\n                onAction: () => onEdit(editor, event),\n            });\n            editor.ui.registry.addContextToolbar(component, {\n                predicate: (node) => node.classList.contains(classFiltercode)\n                    && !node.classList.contains(classFiltercodeError),\n                items: [\n                    `${component}_edit`,\n                    `${component}_remove`,\n                ].join(' '),\n                position: 'node',\n                scope: 'node'\n            });\n            editor.on('init', () => {\n                onInit(editor);\n            });\n            editor.on('BeforeGetContent', (format) => {\n                onBeforeGetContent(editor, format);\n            });\n            editor.on('focus', () => {\n                onFocus(editor);\n            });\n            editor.on('submit', () => {\n                onSubmit(editor);\n            });\n            editor.on('keydown', (event) => {\n                onDelete(editor, event);\n            });\n        }\n    };\n};\n"],"names":["async","filtercodeNameMapKeys","Object","keys","filtercodeNameMap","filtercodeNameMapValues","values","buttonText","removeTag","editTag","filtercodeStrings","key","component","langKeys","fromEntries","Array","length","fill","map","_","i","editor","ui","registry","addNestedMenuItem","text","getSubmenuItems","filtercodes","codeorgroup","codes","type","getKey","code","onAction","id","addButton","icon","tooltip","event","addContextToolbar","predicate","node","classList","contains","classFiltercode","classFiltercodeError","items","join","position","scope","on","format"],"mappings":"yOAyCwBA,gBACdC,sBAAwBC,OAAOC,KAAKC,2BACpCC,wBAA0BH,OAAOI,OAAOF,4BAE1CG,WACAC,UACAC,WACGC,yBACG,mBAAW,CACb,CAACC,IAAK,0BAA2BC,UAAAA,mBACjC,CAACD,IAAK,wBAAyBC,UAAAA,mBAC/B,CAACD,IAAK,sBAAuBC,UAAAA,sBAC1BP,0BAGLQ,SAAWX,OAAOY,YAAYC,MAAMd,sBAAsBe,QAAQC,KAAK,GACxEC,KAAI,CAACC,EAAGC,IAAM,CAACnB,sBAAsBmB,GAAIV,kBAAkBU,cAExDC,UACA,oCAAwBA,UACxBA,OAAOC,GAAGC,SAASC,kBAAkBZ,kBAAW,CAC5Ca,KAAMlB,WACNmB,gBAAiB,IAAMC,oBAAYT,KAAKU,aAChCA,YAAYC,MACL,CACHC,KAAM,iBACNL,KAAMZ,SAASe,YAAYG,UAC3BL,gBAAiB,IAAME,YAAYC,MAAMX,KAAKc,QAC1CF,KAAM,WACNL,KAAMZ,SAASmB,KAAKD,UACpBE,SAAU,KAAM,uBAAgBZ,OAAQW,KAAKE,SAI9C,CACHJ,KAAM,WACNL,KAAMZ,SAASe,YAAYG,UAC3BE,SAAU,KAAM,uBAAgBZ,OAAQO,YAAYM,SAKpEb,OAAOC,GAAGC,SAASY,UAAUvB,kBAAY,UAAW,CAChDwB,KAAM,SACNC,QAAS7B,UACTyB,SAAU,KAAM,gBAASZ,OAAQiB,SAErCjB,OAAOC,GAAGC,SAASY,UAAUvB,kBAAY,QAAS,CAC9CwB,KAAM,aACNC,QAAS5B,QACTwB,SAAU,KAAM,cAAOZ,OAAQiB,SAEnCjB,OAAOC,GAAGC,SAASgB,kBAAkB3B,kBAAW,CAC5C4B,UAAYC,MAASA,KAAKC,UAAUC,SAASC,2BACrCH,KAAKC,UAAUC,SAASE,8BAChCC,MAAO,WACAlC,qCACAA,8BACLmC,KAAK,KACPC,SAAU,OACVC,MAAO,SAEX5B,OAAO6B,GAAG,QAAQ,oBACP7B,WAEXA,OAAO6B,GAAG,oBAAqBC,oCACR9B,OAAQ8B,WAE/B9B,OAAO6B,GAAG,SAAS,qBACP7B,WAEZA,OAAO6B,GAAG,UAAU,sBACP7B,WAEbA,OAAO6B,GAAG,WAAYZ,yBACTjB,OAAQiB"}